name: MinIO Build & Publish
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0,6,12,18 * * *'

concurrency:
  group: "compile"
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  check_tags:
    name: Resolve latest local and upstream tags
    runs-on: ubuntu-latest
    outputs:
      latest_mio_tag: ${{ steps.tags.outputs.upstream_tag }}
      latest_local_tag: ${{ steps.tags.outputs.local_release }}
    steps:
      - name: Get latest tag information
        id: tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_MIO_TAG="$(git ls-remote --tags --refs --sort='-v:refname' "https://github.com/minio/minio.git" \
            | grep -m1 RELEASE. | awk -F/ '{print $3}' | sed 's/\^{}//' | sed 's/^RELEASE\.//')"
          LATEST_LOCAL_RELEASE="$(gh api "repos/${GITHUB_REPOSITORY}/releases/latest" --jq '.tag_name' || true)"

          echo "upstream_tag=$LATEST_MIO_TAG" >> "$GITHUB_OUTPUT"
          echo "local_release=$LATEST_LOCAL_RELEASE" >> "$GITHUB_OUTPUT"

  compile:
    name: Compile Binary (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: check_tags
    if: ${{ needs.check_tags.outputs.latest_mio_tag != needs.check_tags.outputs.latest_local_tag }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - { goos: linux, goarch: ppc64le, docker: false }
          - { goos: linux, goarch: mips, docker: false }
          - { goos: linux, goarch: mips64, docker: false }
          - { goos: linux, goarch: amd64, docker: true }
          - { goos: linux, goarch: arm, docker: false }
          - { goos: linux, goarch: arm64, docker: true }
          - { goos: linux, goarch: s390x, docker: false }
          - { goos: linux, goarch: riscv64, docker: false }
          - { goos: linux, goarch: 386, docker: false }

          - { goos: darwin, goarch: arm64, docker: false }
          - { goos: darwin, goarch: amd64, docker: false }

          - { goos: netbsd, goarch: amd64, docker: false }
          - { goos: freebsd, goarch: amd64, docker: false }
          - { goos: openbsd, goarch: amd64, docker: false }

          - { goos: windows, goarch: amd64, docker: false }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          cache: false
          check-latest: true
          go-version: "stable"

      - name: Clone MinIO
        run: |
          git clone --depth=1 --branch RELEASE.${{ needs.check_tags.outputs.latest_mio_tag }} https://github.com/minio/minio.git minio-src

      - name: Generate ldflags
        id: gen_ldflags
        working-directory: minio-src
        env:
          MINIO_RELEASE: "RELEASE"
        run: |
          LDFLAGS=$(go run buildscripts/gen-ldflags.go ${{ needs.check_tags.outputs.latest_mio_tag }})
          echo "ldflags=$LDFLAGS" >> $GITHUB_OUTPUT

      - name: Build binary
        working-directory: minio-src
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
          GO111MODULE: "on"
        run: |
          mkdir -p dist/
          go build -trimpath -tags kqueue --ldflags "${{ steps.gen_ldflags.outputs.ldflags }}" -o $(pwd)/dist/minio

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: "minio-src/dist/**"
          name: "minio-${{ matrix.goos }}-${{ matrix.goarch }}"
          retention-days: 1
          if-no-files-found: "error"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ matrix.docker }}
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker BuildX
        uses: docker/setup-buildx-action@v3
        if: ${{ matrix.docker }}
        with:
          version: latest

      - name: Publish to Docker Hub
        uses: docker/build-push-action@v6
        if: ${{ matrix.docker }}
        env:
          DOCKER_BUILD_RECORD_UPLOAD: false
        with:
          push: true
          file: "Dockerfile"
          context: "minio-src"
          sbom: true
          provenance: true
          platforms: "${{ matrix.goos }}/${{ matrix.goarch }}"
          tags: docker.io/derklaro/minio:${{ needs.check_tags.outputs.latest_mio_tag }}-${{ matrix.goarch }}
          build-args: |
            RELEASE=${{ needs.check_tags.outputs.latest_mio_tag }}
            TARGETARCH=${{ matrix.goos }}/${{ matrix.goarch }}

  publish_release:
    name: Publish Release
    needs:
      - check_tags
      - compile
    runs-on: ubuntu-latest
    if: ${{ needs.check_tags.outputs.latest_mio_tag != needs.check_tags.outputs.latest_local_tag }}
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Package binaries
        run: |
          set -euo pipefail
          mkdir -p release
          for dir in binaries/*; do
            [ -d "$dir" ] || continue
            name="$(basename "$dir")"                   # minio-linux-amd64
            os="$(echo "$name" | cut -d- -f2)"          # linux/darwin/windows/...
            arch="$(echo "$name" | cut -d- -f3)"        # amd64/arm64/...
            bin="$dir/minio"

            if [ "$os" = "windows" ]; then
              if [ -f "$bin" ] && [ ! -f "$dir/minio.exe" ]; then mv "$bin" "$dir/minio.exe"; fi
              ( cd "$dir" && zip -r "../../release/minio-${os}-${arch}.zip" "minio.exe" )
            else
              chmod +x "$bin" || true
              tar -C "$dir" -czf "release/minio-${os}-${arch}.tar.gz" "minio"
            fi
          done

          ( cd release && sha256sum * > SHA256SUMS )

      - name: Prepare GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          tag_name: ${{ needs.check_tags.outputs.latest_mio_tag }}
          fail_on_unmatched_files: true
          body: |
            Automated binary publish of minio version released on ${{ needs.check_tags.outputs.latest_mio_tag }}
            See: https://github.com/minio/minio/releases/tag/RELEASE.${{ needs.check_tags.outputs.latest_mio_tag }}
          files: |
            release/*.tar.gz
            release/*.zip
            release/SHA256SUMS

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          make_latest: true
          tag_name: ${{ needs.check_tags.outputs.latest_mio_tag }}

  update_docker_hub_description:
    name: Update Dockerhub description
    needs: publish_release
    runs-on: ubuntu-latest
    if: ${{ needs.check_tags.outputs.latest_mio_tag != needs.check_tags.outputs.latest_local_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Update Dockerhub Description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: "derklaro/minio"
          enable-url-completion: true
